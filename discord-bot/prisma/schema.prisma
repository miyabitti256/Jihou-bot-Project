generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma/client"
}

datasource db {
  provider = "postgresql"
}

model Guild {
  id               String             @id @unique
  name             String
  memberCount      Int
  iconUrl          String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  channels         GuildChannels[]
  members          GuildMembers[]
  roles            GuildRoles[]
  ScheduledMessage ScheduledMessage[]

  @@map("guilds")
}

model GuildChannels {
  id               String             @id @unique
  guildId          String
  name             String
  type             String
  guild            Guild              @relation(fields: [guildId], references: [id], onDelete: Cascade)
  ScheduledMessage ScheduledMessage[]

  @@map("guild_channels")
}

model GuildRoles {
  id          String  @id @unique
  guildId     String
  name        String
  color       String
  hoist       Boolean
  position    Int
  permissions String
  managed     Boolean
  mentionable Boolean
  guild       Guild   @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@map("guild_roles")
}

model GuildMembers {
  guildId  String
  userId   String
  nickname String?
  joinedAt DateTime
  guild    Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  user     Users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([guildId, userId])
  @@map("guild_members")
}

model Users {
  id                       String             @id @unique
  username                 String
  discriminator            String?
  avatarUrl                String?
  money                    Int                @default(1000)
  lastDraw                 DateTime?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt
  createdThreads           ChatThread[]
  CoinFlip                 CoinFlip[]
  guildMembers             GuildMembers[]
  JankenChallenger         Janken[]           @relation("challenger")
  JankenOpponent           Janken[]           @relation("opponent")
  JankenRoomGuest          JankenRoom[]       @relation("RoomGuest")
  JankenRoomHost           JankenRoom[]       @relation("RoomHost")
  Omikuji                  Omikuji[]
  ScheduledMessage         ScheduledMessage[] @relation("CreatedBy")
  updatedScheduledMessages ScheduledMessage[] @relation("UpdatedBy")
  userSettings             UserSettings?

  @@map("users")
}

model UserSettings {
  userId    String  @unique
  theme     theme   @default(system)
  locale    String?
  published Boolean @default(false)
  user      Users   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model ScheduledMessage {
  id                String        @id @unique @default(cuid())
  channelId         String
  message           String
  scheduleTime      String        @map("time")
  createdUserId     String
  lastUpdatedUserId String
  isActive          Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  guildId           String
  channel           GuildChannels @relation(fields: [channelId], references: [id], onDelete: Cascade)
  createdUser       Users         @relation("CreatedBy", fields: [createdUserId], references: [id], onDelete: Cascade)
  guild             Guild         @relation(fields: [guildId], references: [id], onDelete: Cascade)
  updatedUser       Users         @relation("UpdatedBy", fields: [lastUpdatedUserId], references: [id], onDelete: Cascade)

  @@map("scheduled_messages")
}

model Omikuji {
  id        String   @id @unique @default(cuid())
  userId    String
  result    String
  createdAt DateTime @default(now())
  user      Users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("omikuji")
}

model CoinFlip {
  id           String   @id @unique @default(cuid())
  userId       String
  bet          Int
  win          Boolean
  updatedMoney Int
  createdAt    DateTime @default(now())
  user         Users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("coin_flip")
}

model Janken {
  id             String   @id @unique @default(cuid())
  bet            Boolean
  challengerId   String
  opponentId     String
  challengerHand String
  opponentHand   String
  challengerBet  Int?
  opponentBet    Int?
  winnerUserId   String?
  createdAt      DateTime @default(now())
  challenger     Users    @relation("challenger", fields: [challengerId], references: [id], onDelete: Cascade)
  opponent       Users    @relation("opponent", fields: [opponentId], references: [id], onDelete: Cascade)

  @@index([challengerId], map: "challenger_id_idx")
  @@index([opponentId], map: "opponent_id_idx")
  @@map("janken")
}

model JankenRoom {
  id           String     @id @unique @default(cuid())
  roomCode     String     @unique
  name         String?
  description  String?
  platform     platform
  channelId    String?
  status       RoomStatus
  isPrivate    Boolean    @default(false)
  hostId       String
  guestId      String?
  bet          Boolean
  betAmount    Int?
  currentRound Int        @default(0)
  hostWins     Int        @default(0)
  guestWins    Int        @default(0)
  draws        Int        @default(0)
  hostReady    Boolean    @default(false)
  guestReady   Boolean    @default(false)
  lastActivity DateTime   @default(now())
  lastUpdated  DateTime   @default(now()) @updatedAt
  expiresAt    DateTime
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  guest        Users?     @relation("RoomGuest", fields: [guestId], references: [id], onDelete: Cascade)
  host         Users      @relation("RoomHost", fields: [hostId], references: [id], onDelete: Cascade)

  @@index([status], map: "status_idx")
  @@index([lastUpdated], map: "last_updated_idx")
  @@map("janken_rooms")
}

model ChatThread {
  id        String        @id @unique
  title     String?
  guildId   String
  channelId String
  creatorId String
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  ChatMessage[]
  creator   Users         @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([channelId], map: "channel_id_idx")
  @@map("chat_threads")
}

model ChatMessage {
  id         String     @id @unique @default(cuid())
  threadId   String
  content    String
  role       ChatRole
  tokenCount Int
  createdAt  DateTime   @default(now())
  thread     ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId], map: "thread_id_idx")
  @@map("chat_messages")
}

enum theme {
  system
  light
  dark
}

enum platform {
  WEB
  DISCORD
}

enum RoomStatus {
  WAITING
  PLAYING
  FINISHED
  CANCELLED
}

enum ChatRole {
  SYSTEM
  USER
  ASSISTANT
}
